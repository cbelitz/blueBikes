---
title: "Final Report: Boston Bluebikes"
author: "Clara Belitz and Phil Graff"
date: "5/12/2021"
output: pdf_document
fig_caption: yes
---

```{r echo = FALSE, warning=FALSE, message=FALSE}

# ^^ the echo = FALSE is a useful parameter; it will prevent code blocks from being shown in the report. We may want to use this frequently.


# set global plot size options so they look better 
knitr::opts_chunk$set(fig.width=8, fig.height=4, warning=FALSE, message=FALSE)

# Call libraries

library(tidyverse)  # I think we want tidyverse? May take out if not needed, or if conflicts with other functions

# Maybe for the other functions, we can just call them where they are needed.

library(knitr)

```

# Background / Problem Space

Bike shares have helped cities meet the transportation needs of their citizens in a way that promotes healthy activity and reduces negative environmental impact. Boston launched their Bluebikes program in 2011 with 60 stations. It has grown each year and now hosts 380 stations across the Boston metro area.

In this report, we will analyze bike usage through the lens of possible stakeholders: local officials and urban planners in participating municipalities and bike share operators. We will attempt to predict ride starts and flow (ride ends minus ride starts) on a daily basis at each participating station in the month of September 2019.


# Data Sources and Processing

## Data Sources

Boston Bluebikes publishes their anonymized and cleaned bike rental data online. The cleaned data has removed trips that are taken by staff as they service and inspect the system; and any trips that were below 60 seconds in length. Individual ride data was grouped and summarized by station and day.

In addition to the ride data, we are including the following external data sources:

* Weather: Cyclists are exposed to the elements, so weather conditions may have an impact on a personâ€™s decision to rent a bike on a given day. From Weather Underground we can obtain the historical record of daily weather data for Boston, Our analysis uses average temperature and precipitation.

* Distance to T stop: Because bike shares are part of city-wide infrastructure, we may expect popular stations to be located at or near public transit stops.

* Distance to bike lane: The proximity to bike lanes may influence the popularity of stations. We can calculate distance to the nearest bike lane from a given station.

## Data Processing

During exploratory data analysis, we plotted total rides by day of week (Figure \ref{fig:figweekdayend} below) and discovered two things. First, there is a pattern of higher total rides on weekdays versus weekends. We can recode the day of week predictor to a weekend/weekday factor to reduce the dimensionality. Second, Monday Sept 2 appears to be an outlier due to the federal holiday Labor Day.

```{r figweekdayend, echo = FALSE, warning=FALSE, message=FALSE,fig.cap="\\label{fig:figweekdayend}Rides by Date"}

tripClasses <- c("factor", "Date", "integer", "integer", "integer", "factor", "factor", "factor", "factor", "integer", "numeric", "numeric", "integer", "numeric", "integer", "integer", "numeric","integer","numeric")
trips <- read.csv("data/trips_per_day_09_19.csv", colClasses = tripClasses)
rm(tripClasses) #cleanup environment
# Categorize weekday/weekend
trips$weekdayend <- as.factor(ifelse(trips$weekday %in% c("Sunday","Saturday"), "weekend", "weekday"))
attach(trips)

daily <- trips %>% group_by(date, weekday, weekdayend, Precipitation, TempAvg) %>% summarize(starts = sum(total.start), ends = sum(total.end))

# PLOT: Daily Starts (Rides) by Date
#plot(daily$date,daily$starts)
ggplot(data = daily, aes(date, starts, colour = weekdayend)) +
  geom_point(size = 3) +
  geom_abline(intercept = 0, slope = 0, size = 1) +
  ggtitle("Total Rides by Date") +
  xlab("Date") +
  ylab("Total Rides")

detach(trips)
rm(daily)
rm(trips)

```


# Research Questions

**RQ1:** Can we classify different stations based on their cluster patterns?

**RQ2:** Can we predict bike rental usage by station, and by extension the positive/negative flow of bikes at that station?

**RQ3:** Can we interpret our results?

# Classifying Stations

We wanted to classify the stations into three bins based on their daily average rental starts. We used K-means clustering algorithm to assign each station an activity level classification of high, medium, or low. These values aid in interpreting plots, but they can also be used in the previous methods as a way to reduce the high dimensionality of one-hot encoded name variables, keeping in mind that these classifications are derived from ride starts, therefore circular in predicting ride starts.

In Figure \ref{fig:figkmeans} below, the stratified bands of color demonstrate how the K-means algorithm grouped these observations according to their activity level.

```{r echo = FALSE, warning=FALSE, message=FALSE}
# ^^ 100 words

# READ in the trips by station, day data
tripClasses <- c("factor", "Date", "integer", "integer", "integer", "factor", "factor", "factor", "factor", "integer", "numeric", "numeric", "integer", "numeric", "integer", "integer", "numeric","integer","numeric")
trips <- read.csv("data/trips_per_day_09_19.csv", colClasses = tripClasses)
rm(tripClasses) #cleanup environment

### K-MEANS CLUSTER

# It seems like it might be helpful, rather than having a factor with 328 levels (each station), maybe to have a grouping
# of activity level, so we could have low-medium-high or some such thing? Would we be able to use clustering models for this?
# This would define an attribute of the station

# Critical question: Is it inappropriate to use k-means on single-vector data? Most of the examples seem to use two-dimensional

set.seed(1)
#total_daily_rides_per_stn <- trips %>% group_by(id) %>% summarise(Trips = sum(total.start)) # not needed
avg_daily_rides_per_stn <- trips %>% group_by(id) %>% summarise(Trips = mean(total.start))
km.out = kmeans(avg_daily_rides_per_stn$Trips, 3 , nstart = 20)
```


```{r figkmeans, echo=FALSE, fig.width=7,fig.height=6,fig.cap="\\label{fig:figkmeans}K Means"}
ggplot(data = avg_daily_rides_per_stn, aes(id, Trips, colour = factor(km.out$cluster))) +
  scale_color_discrete(labels = c('low','medium','high')) +
  labs(color = "Activity Class") +
  geom_point(size = 2) +
  ggtitle("K-Means Clustering to Determine Activity Level")

temp <- data.frame(avg_daily_rides_per_stn$id,as.factor(km.out$cluster))
names(temp) <- c("id","activity_class")

levels(temp$activity_class) <- c("low", "medium", "high")

```

# Predicting Usage and Flow

## Linear Model

PHIL -- 

```{r echo = FALSE, warning=FALSE, message=FALSE}

# READ in the trips by station, day data
# tripClasses is going to force-read the data into R data types that I want them to be
tripClasses <- c("factor", "Date", "integer", "integer", "integer", "factor", "factor", "factor", "factor", "integer", "numeric", "numeric", "integer", "numeric", "integer", "integer", "numeric","integer","numeric")
trips <- read.csv("data/trips_per_day_09_19.csv", colClasses = tripClasses)
rm(tripClasses) #cleanup environment

#####################
### ADD VARIABLES ###
#####################

### NORMALIZE START DATA BY STATION - CALC Z SCORE
# Calc the Z score of the trips per day, by monthly average for that station
# The purpose of this (I think) is to know, for a given station, how many trips is that relative to the std dev of that station
# Because it is hard to compare total trips when certain stations have SOOOO many trips
trips$ztrips <- ave(trips$total.start, trips$id, FUN=scale)

### RECLASSIFY DAY OF WEEK AS WEEKDAY or WEEKEND
# Categorize weekday/weekend
trips$weekdayend <- as.factor(ifelse(trips$weekday %in% c("Sunday","Saturday"), "weekend", "weekday"))


```


## Tree Models

CLARA

## Support Vector Machines

CLARA

## Local Regression

CLARA


# Interpreting Results

PHIL AND CLARA




# Discussion and Conclusion

PHIL AND CLARA